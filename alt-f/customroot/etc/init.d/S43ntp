#! /bin/sh
#
# System-V init script for the openntp daemon
#

DESC="Network Time Protocol Daemon"
TYPE=net
NAME=ntpd
CONF=/etc/ntp.conf
CONFM=/etc/misc.conf
NTPD_CRON=/tmp/ntpd.cron

. $(dirname $0)/common

if test -e $CONFM; then
	. $CONFM
fi

istatus() {
	if test "$NTPD_DAEMON" = "yes"; then
		status $1
	else
		crontab -l 2>/dev/null | grep -q adjtime 
		if test $? = 0; then
			echo "$1 running"
			return 0
		else
			echo "$1 stopped"
			return 1
		fi
	fi
}

update_cron() {
	if test $# = 1; then
		if ! rccron status >& /dev/null; then
			rccron start
		fi
	fi

	crontab -l > "$NTPD_CRON" 2> /dev/null
	if test $? = 1 -a $# = 0 ; then return; fi

	sed -i '/\/usr\/sbin\/adjtime/d' "$NTPD_CRON"

	if test $# = 1; then
		echo "$1" >> "$NTPD_CRON"
	fi
	crontab "$NTPD_CRON"
	rm "$NTPD_CRON"
}

case "$1" in
	start)
		if test "$NTPD_BOOT" = "yes" ; then
			echo -n "$NAME: Getting initial time via ntp: "
			ntpd -qg
			omsg $?
		fi

		if test "$NTPD_DAEMON" = "yes" ; then
			echo -n "Starting $NAME: "
			update_cron
			adjtimex -f 0 >& /dev/null # if != 0 affects ntpd drift calculation 
			start-stop-daemon -S -q -x $NAME
		else
			echo -n "$NAME: Setting up crontab... "
			adjtime -restart >& /dev/null
			update_cron "0 6 * * * /usr/sbin/adjtime -adjust"
		fi
		omsg $?
		;;

	stop) stop $NAME
		update_cron
		;;
	restart) restart $NAME ;;
	status) istatus $NAME ;;
	*) usage $0 "start|stop|status|restart" ;;
esac
