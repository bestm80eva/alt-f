#! /bin/sh

set -e

DESC="The Common Unix Printing System daemon"
TYPE=sys
NAME=cupsd
INETD_CONF=/etc/inetd.conf
PRINTC=/etc/printcap
CUPS_USER=cups
CUPS_GROUP=lpadmin

. $(dirname $0)/common

case "$1" in
	start)
		echo -n "Starting $NAME: "
		export TZ=$(cat /etc/TZ)
		unset TMPDIR
		if test -e $PRINTC; then
			if test -z "$(grep cupsd $PRINTC)"; then 
				mv  $PRINTC ${PRINTC}-safe
			fi
		fi
		sed -i 's/^printer/#printer/' $INETD_CONF
		rcinetd reload

# don't, cupsd must start as root, then it drops privileges (I think)
# --chuid $CUPS_USER:$CUPS_GROUP \
		start-stop-daemon --start --quiet --background --oknodo \
			--exec $NAME 
		while ! cupsctl >& /dev/null ; do usleep 100000; done
		cupsctl _remote_admin=1 _share_printers=1 >& /dev/null
		echo "OK."
		;;

	stop)
		echo -n "Stopping $NAME: "
		start-stop-daemon --stop --quiet --oknodo --exec $NAME
		if test -e ${PRINTC}-safe; then 
				mv $PRINTC-safe $PRINTC
		fi		
		sed -i 's/#printer/printer/' $INETD_CONF
		rcinetd reload
		echo "OK."
		;;

	restart) restart $NAME ;;
	reload) reload $NAME ;;
	status) status $NAME ;;
	*) usage $0 "start|stop|status|restart|reload" ;;
esac
