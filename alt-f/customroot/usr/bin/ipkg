#!/bin/sh

usage() {
	echo "This is a frontend to ipkg.
	ipkg is not installed, install using the web interface,
	or using \"ipkg -install [<mount_point>]\""
	exit 1
}

msg() {
	echo $1
	clean
	exit 1
}

clean() {
	if aufs.sh -u; then
		rm -rf $(readlink -f /Alt-F)
		rm -f /Alt-F
	else
		exit 1
	fi
}

install() {
	echo Installing ipkg
	
	CONFF=/etc/ipkg.conf
	IPKG=ipkg_0.99.163_arm.ipk
	FEED=$(awk '/^src/{print $3}' $CONFF)
	DESTD=$(awk '/^dest/{print $3}' $CONFF)

	if ! nslookup www.dropbox.com >& /dev/null; then
		if ! test -e /tmp/$IPKG; then
			msg "You don't seem to have a name server configured,
or a working internet connection,
and no /tmp/$IPKG file found. Exiting"
		else
			local="true"
		fi
	fi

	if test "$DESTD" != "/Alt-F"; then
		msg "Package destination directory must be /Alt-F"
	fi

	if ! test -d "$DESTD"; then
		msg "Package destination directory not found."
	fi
			
	TMPD=$(mktemp -d -t)
	if test -z "$local"; then
		wget -nv -P $TMPD $FEED/$IPKG >& /dev/null
		if test $? != 0; then
			rm -rf $TMPD
			msg "Downloading of $IPKG from $FEED failed."
		fi
	else
		mv /tmp/$IPKG $TMPD
	fi

	cd $TMPD
	ar x $IPKG
	tar xzf control.tar.gz
	awk '/^Package:/ {
			if( $2 != "ipkg") exit 1 }
		/^Architecture:/ {
			if ($2 != "arm") exit 1 }
		' control
		
	if test $? != 0; then
		rm -rf $TMPD
		msg "Downloaded wrong package?"
	fi
	
	# remount /Alt-F with inotify
	aufs.sh -n
	tar -C /Alt-F -xzf data.tar.gz
	
	cd
	rm -rf $TMPD
	
	if test -z "$local"; then
		ipkg-cl update
		ipkg-cl install ipkg
	fi

	# remount /Alt-F with reval
	aufs.sh -r
	exit 0
}

if test "$#" != 0 -a "$1" = "-clean"; then
	clean

elif test "$#" != 0 -a "$1" = "-install"; then
	if test $# = 1 -a "$(aufs.sh -s)" != "OK"; then
		echo "/Alt-F does not exists or is not an aufs branch."
		echo "you must supply a mountpoint where to install ipkg."
		exit 1

	elif test $# = 1 -a "$(aufs.sh -s)" = "OK"; then
		install

	elif test $# = 2 -a "$(aufs.sh -s)" = "OK"; then
		echo "Alt-F already exists, you shouldn't supply a mountpoint."
		exit 1

	elif test "$#" != 2; then
		usage
	
	elif ! $(mountpoint -q $2); then
		echo "\"$2\" is not a mountpoint."
		exit 1

	else
		aufs.sh -i $2 && install
		exit $?
	fi

elif test -f /usr/bin/ipkg-cl; then
	aufs.sh -n
	ipkg-cl $*
	res=$?
	aufs.sh -r
	exit $res

else
	usage
fi
